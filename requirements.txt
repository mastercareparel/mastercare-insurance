Flask==3.0.3
Werkzeug==3.0.3
mysql-connector-python==9.0.0
Jinja2==3.1.4
itsdangerous==2.2.0
click==8.1.7
MarkupSafe==2.1.5

from flask import Flask, render_template, request, redirect, url_for, session, Response
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import csv, io, mysql.connector
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
app.secret_key = "af3461ecb47ff1337e83807529d3650ab547f086c8daac120b2301aa4eb7ab11"

def get_db_connection():
    try:
        connection = mysql.connector.connect(
            host="srv957.hstgr.io",
            user="u405877670_Mastercare",
            password="Mastercare1!",
            database="u405877670_Mastercare",
            port=3306
        )
        return connection
    except mysql.connector.Error as err:
        print(f"Database connection error: {err}")
        return None



@app.route('/')
def index():
    # Agar user login nahi hai to login page par bhejna
    if 'user_id' not in session:
        return redirect('/login')
    return redirect('/form')  # agar login hai to form page par le jao


@app.route("/register", methods=["GET", "POST"])
def register():
    error = None
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        stored_password = password


        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute(
                "INSERT INTO users (username, password) VALUES (%s, %s)",
                (username, stored_password),
            )
            conn.commit()
            cursor.close()
            conn.close()
            return redirect("/login")

        except mysql.connector.Error as e:
            error = "Username already exists or MySQL error."

    return render_template("register.html", error=error)

@app.route("/login", methods=["GET", "POST"])
def login():
    error = None
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute(
            "SELECT id, username, password FROM users WHERE username=%s", (username,)
        )
        user = cursor.fetchone()
        cursor.close()
        conn.close()

        if user and user[2] == password:
            session["user_id"] = user[0]
            return redirect("/form")
        else:
            error = "Invalid username or password."


    return render_template("login.html", error=error)



@app.route('/logout')
def logout():
    session.clear()
    return redirect('/login')


# -------------------- FORM & CRUD ROUTES --------------------
@app.route('/form')
def form_page():
    if 'user_id' not in session:
        return redirect('/login')
    return render_template('form.html')


@app.route("/add", methods=["POST"])
def add():
    if 'user_id' not in session:
        return redirect('/login')

    form = request.form
    new_entry = {
        "insurance": form.get("insurance"),
        "case_id": form.get("case_id"),  
        "customer": form.get("customer"),
        "model": form.get("model"),
        "imei": form.get("imei"),
        "estimate": form.get("estimate"),
        "repair": form.get("repair"),
        "invoice": form.get("invoice"),
        "paymentDetails": form.get("paymentDetails"),
        "paymentValue": form.get("paymentValue"),
        "paymentDate": form.get("paymentDate"),
        "utr": form.get("utr"),
    }

    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            INSERT INTO submissions (
                user_id, insurance, case_id, customer, model, imei,
                estimate, repair, invoice, paymentDetails, paymentValue,
                paymentDate, utr
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            session['user_id'],
            new_entry["insurance"],
            new_entry["case_id"],
            new_entry["customer"],
            new_entry["model"],
            new_entry["imei"],
            new_entry["estimate"],
            new_entry["repair"],
            new_entry["invoice"],
            new_entry["paymentDetails"],
            new_entry["paymentValue"],
            new_entry["paymentDate"],
            new_entry["utr"]
        ))

        conn.commit()

    except mysql.connector.Error as err:
        print("Database error:", err)
    finally:
        cursor.close()
        conn.close()

    return redirect(url_for("submissions_page"))



@app.route("/submissions")
def submissions_page():
    if 'user_id' not in session:
        return redirect('/login')

    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    query = request.args.get("q", "").lower().strip()

    # ---------- SEARCH MODE ----------
    if query:
        cursor.execute("""
            SELECT * FROM submissions
            WHERE user_id = %s AND (
                LOWER(case_id) LIKE %s OR
                LOWER(imei) LIKE %s OR
                LOWER(customer) LIKE %s OR
                LOWER(insurance) LIKE %s OR
                LOWER(paymentValue) LIKE %s OR
                LOWER(utr) LIKE %s
            )
            ORDER BY id DESC
        """, (
            session['user_id'],
            f"%{query}%",
            f"%{query}%",
            f"%{query}%",
            f"%{query}%",
            f"%{query}%",
            f"%{query}%"
        ))

    # ---------- NORMAL MODE ----------
    else:
        cursor.execute("""
            SELECT * FROM submissions
            WHERE user_id = %s
            ORDER BY id DESC
        """, (session['user_id'],))

    rows = cursor.fetchall()

    cursor.close()
    conn.close()
    return render_template(
        "submissions.html",
        submissions=rows,
        search_query=query
    )

@app.route("/delete/<int:id>")
def delete(id):
    if "user_id" not in session:
        return redirect("/login")

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("DELETE FROM submissions WHERE id=%s AND user_id=%s", (id, session['user_id']))
    conn.commit()

    cursor.close()
    conn.close()

    return redirect(url_for("submissions_page"))

@app.route("/edit/<int:id>", methods=["GET", "POST"])
def edit(id):
    if "user_id" not in session:
        return redirect("/login")

    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    if request.method == "POST":
        form = request.form
        cursor.execute("""
            UPDATE submissions SET 
                insurance=%s, case_id=%s, customer=%s, model=%s, 
                imei=%s, estimate=%s, repair=%s, invoice=%s,
                paymentDetails=%s, paymentValue=%s, paymentDate=%s, utr=%s
            WHERE id=%s AND user_id=%s
        """, (
            form.get("insurance"), form.get("case_id"), form.get("customer"),
            form.get("model"), form.get("imei"), form.get("estimate"),
            form.get("repair"), form.get("invoice"), form.get("paymentDetails"),
            form.get("paymentValue"), form.get("paymentDate"), form.get("utr"),
            id, session['user_id']
        ))

        conn.commit()
        cursor.close()
        conn.close()

        return redirect(url_for("submissions_page"))

    # GET request — fetch old data
    cursor.execute("SELECT * FROM submissions WHERE id=%s AND user_id=%s", (id, session['user_id']))
    data = cursor.fetchone()

    cursor.close()
    conn.close()

    if not data:
        return "Invalid submission", 404

    return render_template("edit.html", submission=data, index=id)

@app.route("/export_csv")
def export_csv():
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)

    cursor.execute("SELECT * FROM submissions WHERE user_id=%s", (session["user_id"],))
    rows = cursor.fetchall()

    if not rows:
        return "No submissions found", 400

    output = io.StringIO()
    writer = csv.writer(output)

    writer.writerow([
        "ID",
        "Insurance",
        "Case ID",
        "Customer",
        "Model",
        "IMEI",
        "Estimate",
        "Repair",
        "Invoice",
        "Payment Details",
        "Payment Value",
        "Payment Date",
        "UTR"
    ])

    for r in rows:
        # ✅ Convert YYYY-MM-DD → DD-MM-YYYY
        date_value = ""
        if r["paymentDate"]:
            try:
                parts = str(r["paymentDate"]).split("-")
                date_value = f"{parts[2]}-{parts[1]}-{parts[0]}"
            except:
                date_value = r["paymentDate"]  # fallback

        writer.writerow([
            r["id"],
            r["insurance"],
            r["caseId"],
            r["customer"],
            r["model"],
            r["imei"],
            r["estimate"],
            r["repair"],
            r["invoice"],
            r["paymentDetails"],
            r["paymentValue"],
            date_value,              # ✅ Correct formatted date 
            r["utr"]
        ])

    return Response(
        output.getvalue(),
        mimetype="text/csv",
        headers={"Content-Disposition": "attachment; filename=submissions.csv"}
    )


if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))  # Default 10000 for local, Render uses $PORT
    app.run(host="0.0.0.0", port=port)
